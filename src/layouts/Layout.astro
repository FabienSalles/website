---
import generateUrl from "@utils/url";

interface Props {
  title: string;
  description?: string;
}

const {
  title,
  description = "Fabien Salles - Je vous aide à produire des applications pérennes"
} = Astro.props;

const currentPath = Astro.url.pathname;
const isEnglishPath = currentPath.startsWith('/en');

// Helper to check if a nav item is active
const isActive = (href: string) => {
  // Exact match
  if (currentPath === href || currentPath === href + '/') return true;
  // For formations, also match sub-pages
  if (href === '/formations' && currentPath.startsWith('/formations/')) return true;
  return false;
};
const translationEnabled = import.meta.env.TRANSLATION_ENABLED === 'true';
const trainingEnabled = import.meta.env.TRAINING_ENABLED === 'true';
const contactEnabled = import.meta.env.CONTACT_ENABLED === 'true';
const aboutEnabled = import.meta.env.ABOUT_ENABLED === 'true';
const cvEnabled = import.meta.env.CV_ENABLED === 'true';
const googleAnalyticsId = import.meta.env.GOOGLE_ANALYTICS_ID;

const routeMapping = {
  '/formations': '/en/training',
  '/en/training': '/formations',
  '/cv': '/en/resume',
  '/en/resume': '/cv',
  '/about': '/en/about',
  '/en/about': '/about',
  '/blog': '/en/blog',
  '/en/blog': '/blog',
  '/contact': '/en/contact',
  '/en/contact': '/contact',
  '/': '/en',
  '/en': '/',
};

let alternateLink = routeMapping[currentPath];

if (!alternateLink) {
  if (currentPath.startsWith('/blog/')) {
    alternateLink = '/en' + currentPath;
  } else if (currentPath.startsWith('/en/blog/')) {
    alternateLink = currentPath.replace('/en', '');
  }
}

---

<!doctype html>
<html lang={isEnglishPath ? 'en' : 'fr'}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="author" content="Fabien Salles" />
    <meta name="keywords" content="Software craftsmanship, craft, architecture, test, TDD, DDD, legacy, refactoring, tech lead, technical coach, trainer, formateur, phpunit, artisanat, architecture hexagonal, BDD, clean architecture, PHP, Nodejs, Symfony" />

    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />

    <link rel="alternate" type="application/rss+xml" title="Fabien Salles - Blog RSS Feed" href={generateUrl('/rss.xml')} />
    <script is:inline type="text/partytown" src=`https://www.googletagmanager.com/gtag/js?id=${googleAnalyticsId}`>
    </script>
    <script is:inline type="text/partytown" define:vars={{googleAnalyticsId}}>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", googleAnalyticsId);
    </script>
  </head>
  <body class="min-h-screen bg-white">
    <header class="fixed w-full bg-gradient-to-r from-orange-900 to-orange-800 z-50 shadow-lg">
      <nav class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <a
            href={isEnglishPath ? '/en' : '/'}
            title="Accueil"
            class="text-xl font-semibold text-white hover:text-orange-200 transition-colors"
            data-astro-reload
          >
            Fabien Salles
          </a>

          <!-- Mobile menu button -->
          <button
            id="mobile-menu-button"
            class="md:hidden text-white p-2 focus:outline-none"
            aria-label="Menu"
          >
            <svg id="menu-icon-open" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
            <svg id="menu-icon-close" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>

          <!-- Desktop menu -->
          <ul class="hidden md:flex gap-6 items-center">
            <li><a href="/accompagnement" class={isActive('/accompagnement') ? 'nav-link-active' : 'nav-link-light'} data-astro-reload>Accompagnement</a></li>
            <li><a href="/audit" class={isActive('/audit') ? 'nav-link-active' : 'nav-link-light'} data-astro-reload>Audit</a></li>
            {
              trainingEnabled &&
              <li><a href={isEnglishPath ? '/en/training' : '/formations'} class={isActive('/formations') ? 'nav-link-active' : 'nav-link-light'} data-astro-reload>{isEnglishPath ? 'Training' : 'Formations'}</a></li>
            }
            <li><a href="/automatisation" class={isActive('/automatisation') ? 'nav-link-active' : 'nav-link-light'} data-astro-reload>Automatisation</a></li>
            <li><a href="/apport-affaires" class={isActive('/apport-affaires') ? 'nav-link-active' : 'nav-link-light'} data-astro-reload>Apport d'affaires</a></li>
            <li><a href={generateUrl('/blog')} title="Blog" class={isActive('/blog') ? 'nav-link-active' : 'nav-link-light'} data-astro-reload>Blog</a></li>
            {
              cvEnabled &&
              <li><a href={isEnglishPath ? '/en/resume' : '/cv'} class={isActive('/cv') ? 'nav-link-active' : 'nav-link-light'} data-astro-reload>{isEnglishPath ? 'Resume' : 'CV'}</a></li>
            }
            {
              aboutEnabled &&
              <li><a href={isEnglishPath ? '/en/about' : '/about'} class={isActive('/about') ? 'nav-link-active' : 'nav-link-light'} data-astro-reload>{isEnglishPath ? 'About' : 'À propos'}</a></li>
            }
            {
              contactEnabled &&
              <li><a href={isEnglishPath ? '/en/contact' : '/contact'} class={isActive('/contact') ? 'nav-link-active' : 'nav-link-light'} data-astro-reload>Contact</a></li>
            }
            {
              translationEnabled &&
                <li>
                  <a
                    href={isEnglishPath ? '/' : '/en'}
                    class="lang-switch-light"
                    data-astro-reload
                  >
                    {isEnglishPath ? 'FR' : 'EN'}
                  </a>
                </li>
            }
          </ul>
        </div>

        <!-- Mobile menu -->
        <ul id="mobile-menu" class="hidden md:hidden flex-col gap-4 pt-4 pb-2">
          <li><a href="/accompagnement" class={`block py-2 ${isActive('/accompagnement') ? 'nav-link-active' : 'nav-link-light'}`} data-astro-reload>Accompagnement</a></li>
          <li><a href="/audit" class={`block py-2 ${isActive('/audit') ? 'nav-link-active' : 'nav-link-light'}`} data-astro-reload>Audit</a></li>
          {
            trainingEnabled &&
            <li><a href={isEnglishPath ? '/en/training' : '/formations'} class={`block py-2 ${isActive('/formations') ? 'nav-link-active' : 'nav-link-light'}`} data-astro-reload>{isEnglishPath ? 'Training' : 'Formations'}</a></li>
          }
          <li><a href="/automatisation" class={`block py-2 ${isActive('/automatisation') ? 'nav-link-active' : 'nav-link-light'}`} data-astro-reload>Automatisation</a></li>
          <li><a href="/apport-affaires" class={`block py-2 ${isActive('/apport-affaires') ? 'nav-link-active' : 'nav-link-light'}`} data-astro-reload>Apport d'affaires</a></li>
          <li><a href={generateUrl('/blog')} class={`block py-2 ${isActive('/blog') ? 'nav-link-active' : 'nav-link-light'}`} data-astro-reload>Blog</a></li>
          {
            cvEnabled &&
            <li><a href={isEnglishPath ? '/en/resume' : '/cv'} class={`block py-2 ${isActive('/cv') ? 'nav-link-active' : 'nav-link-light'}`} data-astro-reload>{isEnglishPath ? 'Resume' : 'CV'}</a></li>
          }
          {
            aboutEnabled &&
            <li><a href={isEnglishPath ? '/en/about' : '/about'} class={`block py-2 ${isActive('/about') ? 'nav-link-active' : 'nav-link-light'}`} data-astro-reload>{isEnglishPath ? 'About' : 'À propos'}</a></li>
          }
          {
            contactEnabled &&
            <li><a href={isEnglishPath ? '/en/contact' : '/contact'} class={`block py-2 ${isActive('/contact') ? 'nav-link-active' : 'nav-link-light'}`} data-astro-reload>Contact</a></li>
          }
          {
            translationEnabled &&
              <li>
                <a
                  href={isEnglishPath ? '/' : '/en'}
                  class="block lang-switch-light py-2"
                  data-astro-reload
                >
                  {isEnglishPath ? 'FR' : 'EN'}
                </a>
              </li>
          }
        </ul>
      </nav>
    </header>

    <script>
      const mobileMenuButton = document.getElementById('mobile-menu-button');
      const mobileMenu = document.getElementById('mobile-menu');
      const menuIconOpen = document.getElementById('menu-icon-open');
      const menuIconClose = document.getElementById('menu-icon-close');

      mobileMenuButton?.addEventListener('click', () => {
        mobileMenu?.classList.toggle('hidden');
        mobileMenu?.classList.toggle('flex');
        menuIconOpen?.classList.toggle('hidden');
        menuIconClose?.classList.toggle('hidden');
      });
    </script>

    <main class="pt-20 relative">
      <slot />
    </main>

    <footer class="mt-20 py-8 bg-gray-50 border-t border-gray-100">
      <div class="container mx-auto px-4">
        <div class="flex justify-between items-center">
          <p class="text-gray-600">&copy; {new Date().getFullYear()} Fabien Salles</p>
          <div class="flex gap-4">
            <a
              href="https://www.linkedin.com/in/fabiensalles/"
              target="_blank"
              title="Linkedin Fabien Salles"
              rel="noopener noreferrer"
              class="social-link"
            >
              LinkedIn
            </a>
            {
              contactEnabled &&
              <a href="/contact" class="social-link">
                  Contact
              </a>
            }
            <a href={generateUrl('/rss.xml')} class="social-link" title="RSS Feed">
              RSS
            </a>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>

<style is:global>
  html {
    scroll-behavior: smooth;
  }

  /* Content container styles */
  .content-container {
    @apply relative max-w-4xl mx-auto;
  }

  .content-block {
    @apply relative bg-white p-8 md:p-12 rounded-2xl shadow-lg border border-gray-100;
  }

  /* Button styles */
  .btn {
    @apply inline-flex items-center justify-center px-6 py-3 rounded-xl font-medium transition-all duration-300 transform;
  }

  .btn-primary {
    @apply bg-gradient-to-r from-orange-700 to-orange-800 text-white shadow-lg hover:shadow-xl hover:-translate-y-0.5;
  }

  .btn-outline {
    @apply border-2 border-orange-700 text-orange-700 hover:bg-orange-50;
  }

  /* Navigation styles */
  .nav-link {
    @apply relative text-gray-700 hover:text-orange-700 transition-colors duration-300;
  }

  .nav-link::after {
    content: '';
    @apply absolute left-0 bottom-0 w-0 h-0.5 bg-gradient-to-r from-orange-700 to-orange-800 transition-all duration-300;
  }

  .nav-link:hover::after {
    @apply w-full;
  }

  .lang-switch {
    @apply relative px-4 py-2 text-sm font-medium text-gray-700 rounded-lg transition-all duration-300 hover:bg-orange-50;
  }

  /* Navigation styles for dark background */
  .nav-link-light {
    @apply relative text-white hover:text-orange-200 transition-colors duration-300;
  }

  .nav-link-light::after {
    content: '';
    @apply absolute left-0 bottom-0 w-0 h-0.5 bg-white transition-all duration-300;
  }

  .nav-link-light:hover::after {
    @apply w-full;
  }

  .lang-switch-light {
    @apply relative px-4 py-2 text-sm font-medium text-white rounded-lg transition-all duration-300 hover:bg-orange-700;
  }

  /* Active navigation state */
  .nav-link-active {
    @apply relative px-4 py-2 bg-white text-gray-900 font-medium rounded-full transition-all duration-300;
  }

  /* Social link styles */
  .social-link {
    @apply relative text-gray-600 hover:text-orange-700 transition-colors duration-300;
  }

  .social-link::after {
    content: '';
    @apply absolute left-0 bottom-0 w-0 h-0.5 bg-gradient-to-r from-orange-700 to-orange-800 transition-all duration-300;
  }

  .social-link:hover::after {
    @apply w-full;
  }

  /* Card styles */
  .card {
    @apply bg-white p-6 rounded-xl border border-gray-100 shadow-lg hover:shadow-xl transition-all duration-300;
  }

  /* Section styles */
  .section-title {
    @apply text-3xl font-bold mb-8 bg-gradient-to-r from-orange-700 to-orange-800 bg-clip-text text-transparent;
  }

  /* Form styles */
  .form-input,
  .form-select,
  .form-textarea {
    @apply w-full px-4 py-3 rounded-lg border border-gray-200
           focus:ring-2 focus:ring-orange-500 focus:border-orange-500
           bg-white transition-all duration-300;
  }

  /* Typography */
  .gradient-text {
    @apply bg-gradient-to-r from-orange-700 to-orange-800 bg-clip-text text-transparent;
  }

  /* Page section */
  .page-section {
    @apply relative z-10 bg-white rounded-2xl shadow-lg border border-gray-100 p-8 md:p-12 mb-8;
  }

  p img {
    @apply block mx-auto;
  }

  .image-source {
      @apply text-xs text-gray-500 italic;
  }
</style>